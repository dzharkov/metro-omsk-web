{% extends "base.html" %}
{% load staticfiles %}
{#{% load json_filters %}#}
{% block additional_head %}

    <style type="text/css">
        #metro-map {
            width: 100%;
            height: 100%;
        }

        /*noinspection CssUnusedSymbol*/
        .line {
            fill: none;
            stroke-width: 3;
        }

        /*noinspection CssUnusedSymbol*/
        .station {
            cursor: pointer;
            position: relative;
        }

        #path-search-container {
            position: absolute;
            right: 2em;
            top: 2em
        }

        /*noinspection CssUnusedSymbol*/
        .transition {
            stroke: #743500;
            stroke-width: 4;
        }
    </style>
    <script type="application/javascript">
        const CITY_ID = parseInt({{ city.id }}) ? {{ city.id }} : -1;
        const CIRCLE_RADIUS = 8;
        {#        const CITY = JSON.parse(decodeURIComponent('{{ city|jsonify }}'));#}
        var CITY = undefined;
        var STATIONS = undefined;

        function toScreenCoordinates(a, svg) {
            var multiplier = Math.min($(svg).height(), $(svg).width());
            return Math.ceil(a * 0.8 * multiplier) + multiplier * 0.1
        }

        function drawLine(line) {
            //noinspection JSUnresolvedVariable
            this.svg.append($('<polyline>')
                            .addClass('line')
                            .attr('style', 'stroke:' + line.color)
                            .attr('points', line.stations.map(function (station) {
                                return station.x + ',' + station.y;
                            }).join(' '))
            );
            for (var i in line.stations) {
                if (!line.stations.hasOwnProperty(i)) continue;
                var station = line.stations[i];
                var circle = $('<circle>').addClass('station').attr({
                    style: 'stroke:' + line.color + ';fill: ' + line.color,
                    cx: station.x,
                    cy: station.y,
                    r: CIRCLE_RADIUS,
                    'data-title': station.name,
                    'data-station-id': station.id
                });
                {#                $(circle).click(handler(station.id));#}
                {#                circle = $('<image></image>').addClass('station').attr({#}
                {#                    x: Math.ceil(station.x - 8),#}
                {#                    y: Math.ceil(station.y - 8),#}
                {#                    width: 15,#}
                {#                    height: 15,#}
                {#                    'xlink:href': '{% static "img/omich.jpg" %}'#}
                {#                });#}
                this.svg.append(circle);
            }
        }

        function drawTransition(transition) {
            var stationFrom = STATIONS.filter(function (e) {
                return e.id == transition.from_id
            })[0];
            console.log(transition);
            var stationTo = STATIONS.filter(function (e) {
                return e.id == transition.to_id
            })[0];
            var line = $('<line>').attr({
                x1: stationFrom.x,
                y1: stationFrom.y,
                x2: stationTo.x,
                y2: stationTo.y

            }).addClass('transition');
            this.svg.append(line);
        }

        function drawText(station) {
            var text = $('<text>' + station.name + '</text>').attr({
                id: 'stationName' + station.id,
                x: station.x + CIRCLE_RADIUS * 1.5,
                y: station.y + CIRCLE_RADIUS / 2,
                style: 'fill: black'
            });
            this.svg.append(text)
        }

        function findPath() {
            var sourceId = $('#sourceStation').val(),
                    destinationId = $('#destinationStation').val();
            if (!(sourceId && destinationId && CITY)) return;
            // here goes dijkstra
        }

        $(document).ready(function () {
            var svg = $('#metro-map');

            $.ajax('/backend/' + CITY_ID).done(function (city) {
                console.log(city);

                CITY = city;
                STATIONS = _.flatten(city.lines.map(function (line) {
                    return line.stations;
                }));
                STATIONS.forEach(function (station) {
                    station.x = toScreenCoordinates(station.x, svg);
                    station.y = toScreenCoordinates(1 - station.y, svg);
                });

                city.transitions.forEach(_.bind(drawTransition, {svg: svg}));
                city.lines.forEach(_.bind(drawLine, {svg: svg}));
                STATIONS.forEach(_.bind(drawText, {svg: svg}));

                //noinspection JSJQueryEfficiency
                $("body").html($("body").html());

                $('#metro-map').find('circle').popover({
                    container: 'body',
                    trigger: 'focus',
                    content: $('.popover-buttons').html(),
                    html: true,
                    placement: 'right'
                }).on('shown.bs.popover', function () {
                    var $this = $(this);
                    var stationId = $this.data('stationId');
                    var tip = $this.data('popover').$tip;
                    tip.find('.add-source-button').click(function () {
                        $('#sourceStation').val(stationId);
                    });
                    tip.find('.add-destination-button').click(function () {
                        $('#destinationStation').val(stationId);
                    });
                }).focus(function () {
                    $('text#stationName' + $(this).data('stationId')).fadeOut();
                }).focusout(function () {
                    $('text#stationName' + $(this).data('stationId')).fadeIn();
                });
                $('.path-search-container select').change(findPath)
            });
        })
    </script>
{% endblock %}
{% block content %}
    <svg id="metro-map" xmlns="http://www.w3.org/2000/svg"></svg>
    <div id="path-search-container" role="form">
        <h3 class="page-header">{{ city.name }}</h3>

        <div class="form-group">
            <label for="sourceStation" class="col-sm-2 control-label">Откуда</label>
            <select id="sourceStation" class="form-control">
                <option selected value=""></option>
                {% for line in city.lines.all %}
                    <optgroup label="{{ line.name }}">
                        {% for station in line.stations.all %}
                            <option value="{{ station.id }}">{{ station.name }}</option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="destinationStation" class="col-sm-2 control-label">Куда</label>
            <select id="destinationStation" class="form-control">
                <option selected value=""></option>
                {% for line in city.lines.all %}
                    <optgroup label="{{ line.name }}">
                        {% for station in line.stations.all %}
                            <option value="{{ station.id }}">{{ station.name }}</option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="popover-buttons" style="display: none">
        <div class="btn-group">
            <button class="btn btn-default add-source-button" type="button">Отсюда</button>
            <button class="btn btn-default add-destination-button" type="button">Сюда</button>
        </div>
    </div>
{% endblock %}