{% extends "base.html" %}
{% load staticfiles %}
{% block additional_head %}

    <style type="text/css">
        #metro-map {
            width: 100%;
            height: 100%;
        }

        /*noinspection CssUnusedSymbol*/
        .line {
            fill: none;
            stroke-width: 3
        }

        /*noinspection CssUnusedSymbol*/
        .station {
            cursor: pointer;
        }

        #search-container {
            position: absolute;
            right: 2em;
            top: 2em
        }
    </style>
    <script type="application/javascript">
        function toScreenCoordinates(a, svg) {
            var multiplier = Math.min($(svg).height(), $(svg).width());
            return Math.ceil(a * 0.8 * multiplier) + multiplier * 0.1
        }
        function drawLine(svg, line) {
            svg = $(svg);
            //noinspection JSUnresolvedVariable
            var stations = line.stations;
            stations.forEach(function (station) {
                station.x = toScreenCoordinates(station.x, svg);
                station.y = toScreenCoordinates(1 - station.y, svg);
            });
            svg.append($('<polyline>')
                            .addClass('line')
                            .attr('style', 'stroke:' + line.color)
                            .attr('points', stations.map(function (station) {
                                return station.x + ',' + station.y;
                            }).join(' '))
            );
            console.log(stations);
            for (var i in stations) {
                if (!stations.hasOwnProperty(i)) continue;
                var station = stations[i];
                var circle = $('<circle>').addClass('station').attr({
                    style: 'stroke:' + line.color + ';fill: ' + line.color,
                    cx: station.x,
                    cy: station.y,
                    r: 8
                });
                svg.append(circle);
                {#                var image = $('<image></image>').addClass('station').attr({#}
                {#                    x: Math.ceil(station.x - 8),#}
                {#                    y: Math.ceil(station.y - 8),#}
                {#                    width: 15,#}
                {#                    height: 15,#}
                {#                    'xlink:href': '{% static "img/omich.jpg" %}'#}
                {#                });#}
                {#                svg.append(image);#}
            }

        }
        var cityId = {{ city.id }};
        $(document).ready(function () {
            var svg = $('#metro-map');
            var drawLineSvg = function (line) {
                drawLine(svg, line)
            };

            $.ajax('/backend/' + cityId).done(function (city) {
                console.log(city);
                //noinspection JSUnresolvedVariable
                city.lines.forEach(drawLineSvg);
                //noinspection JSJQueryEfficiency
                $("body").html($("body").html());
            });

        })
    </script>
{% endblock %}
{% block content %}
    <svg id="metro-map" xmlns="http://www.w3.org/2000/svg"></svg>
    <div id="search-container" role="form">
        <div class="form-group">
            <label for="sourceStation" class="col-sm-2 control-label">Откуда</label>
            <select id="sourceStation" class="form-control">
                {% for station in stations %}
                    <option value="{{ station.id }}">{{ station.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="destinationStation" class="col-sm-2 control-label">Куда</label>
            <select id="destinationStation" class="form-control">
                {% for station in stations %}
                    <option value="{{ station.id }}">{{ station.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-default">Поехали</button>
    </div>
{% endblock %}